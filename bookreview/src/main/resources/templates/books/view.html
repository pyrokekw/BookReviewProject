<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${book.title + ' - BookReview'}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .book-cover {
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 12px;
        }
        .action-btn {
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            transform: scale(1.05);
        }
        .comment {
            border-left: 3px solid #e9ecef;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        .comment:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
<!-- Навигационная панель -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold" th:href="@{/books}">
            <i class="bi bi-book-half me-2"></i>BookReview
        </a>

        <div class="navbar-nav ms-auto">
            <a class="nav-link" th:href="@{/books}">
                <i class="bi bi-arrow-left me-1"></i>Назад к книгам
            </a>
        </div>
    </div>
</nav>

<main class="container py-4">
    <!-- Сообщение об успешном обновлении -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <!-- Хлебные крошки -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/books}" class="text-decoration-none">Книги</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${book.title}"></li>
        </ol>
    </nav>

    <!-- Информация о книге -->
    <div class="row fade-in">
        <div class="col-md-4 text-center mb-4">
            <!-- Просто используем coverUrl - сервис уже гарантирует что она всегда будет -->
            <img th:src="${book.coverUrl}" th:alt="${book.title}"
                 class="book-cover img-fluid mb-3">

            <div class="d-grid gap-2">
                <!-- Кнопка "Читать книгу" показывается только если есть fileUrl -->
                <div th:if="${book.fileUrl != null}">
                    <a th:href="${book.fileUrl}" class="btn btn-success btn-lg action-btn w-100" target="_blank">
                        <i class="bi bi-book me-2"></i>Читать книгу
                    </a>
                </div>

                <!-- Если файла нет, показываем сообщение -->
                <div th:unless="${book.fileUrl != null}" class="alert alert-info text-center py-2">
                    <small><i class="bi bi-info-circle me-1"></i>Электронная версия недоступна</small>
                </div>

                <!-- Кнопка редактирования для админа -->
                <div sec:authorize="hasRole('ROLE_ADMIN')">
                    <a th:href="@{'/books/' + ${book.id} + '/edit'}" class="btn btn-outline-primary btn-lg action-btn w-100">
                        <i class="bi bi-pencil-square me-2"></i>Редактировать книгу
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <h1 class="display-5 fw-bold text-primary mb-3" th:text="${book.title}"></h1>
            <h4 class="text-muted mb-4" th:text="'Автор: ' + ${book.author}"></h4>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-info-circle text-primary me-2"></i>Описание</h5>
                    <p class="card-text lead" th:text="${book.description ?: 'Описание отсутствует'}"></p>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <!-- Форма добавления рецензии -->
    <div class="row" sec:authorize="isAuthenticated()">
        <div class="col-lg-8 mx-auto">
            <div class="card border-primary shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-pencil me-2"></i>Оставить рецензию</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/reviews/add}" method="post">
                        <input type="hidden" name="bookId" th:value="${book.id}">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ваше мнение о книге</label>
                            <textarea name="text" class="form-control" placeholder="Поделитесь своими впечатлениями..."
                                      rows="5" required style="resize: none;"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100 action-btn">
                            <i class="bi bi-send me-2"></i>Опубликовать рецензию
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row" sec:authorize="not isAuthenticated()">
        <div class="col-lg-8 mx-auto">
            <div class="alert alert-info text-center">
                <h6><i class="bi bi-info-circle me-2"></i>Хотите оставить рецензию?</h6>
                <p class="mb-0">Пожалуйста, <a th:href="@{/login}" class="alert-link">войдите</a> или <a th:href="@{/register}" class="alert-link">зарегистрируйтесь</a></p>
            </div>
        </div>
    </div>

    <!-- Список рецензий -->
    <div class="row mt-5" id="reviews-section">
        <div class="col-lg-10 mx-auto">
            <h3 class="mb-4 border-bottom pb-2">
                <i class="bi bi-chat-text text-primary me-2"></i>
                Рецензии
                <span class="badge bg-primary ms-2" th:text="${reviews != null ? reviews.size() : 0}"></span>
            </h3>

            <div th:if="${reviews != null and !reviews.empty}">
                <div th:each="review : ${reviews}" class="card mb-4 border-0 shadow-sm fade-in" th:id="'review-' + ${review.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title text-primary mb-0" th:text="${review.username}"></h6>
                            <small class="text-muted" th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}"></small>
                        </div>

                        <p class="card-text" th:text="${review.text}"></p>

                        <!-- Действия -->
                        <div class="d-flex gap-2 align-items-center">
                            <!-- Лайк -->
                            <form th:action="@{/likes/review/{id}(id=${review.id})}" method="post">
                                <button type="submit" class="btn btn-outline-danger btn-sm action-btn"
                                        th:disabled="${#authentication.name == review.username}"
                                        th:classappend="${#authentication.name == review.username} ? 'opacity-50' : ''">
                                    <i class="bi bi-heart"></i>
                                    <span th:text="${review.likesCount}">0</span>
                                </button>
                            </form>

                            <!-- Управление для автора рецензии -->
                            <div th:if="${#authentication.name == review.username}">
                                <button class="btn btn-outline-primary btn-sm action-btn" data-bs-toggle="modal"
                                        data-bs-target="#editReviewModal"
                                        th:attr="data-review-id=${review.id}, data-review-text=${review.text}">
                                    <i class="bi bi-pencil"></i> Изменить
                                </button>

                                <form th:action="@{/reviews/{id}/delete(id=${review.id})}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger btn-sm action-btn"
                                            onclick="return confirm('Удалить рецензию?')">
                                        <i class="bi bi-trash"></i> Удалить
                                    </button>
                                </form>
                            </div>

                            <!-- Удаление для админа (для чужих рецензий) -->
                            <div th:if="${#authentication.name != review.username}" sec:authorize="hasRole('ROLE_ADMIN')">
                                <form th:action="@{/reviews/{id}/delete(id=${review.id})}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm action-btn"
                                            onclick="return confirm('Удалить рецензию?')">
                                        <i class="bi bi-shield-x"></i> Удалить
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- БЛОК КОММЕНТАРИЕВ -->
                        <div class="comments-section mt-4 pt-3 border-top">
                            <h6 class="mb-3">
                                <i class="bi bi-chat-left-text me-1"></i>
                                Комментарии
                                <span class="badge bg-secondary ms-1" th:text="${review.comments != null ? review.comments.size() : 0}">0</span>
                            </h6>

                            <!-- Список комментариев -->
                            <div th:if="${review.comments != null and !review.comments.empty}">
                                <div th:each="comment : ${review.comments}" th:if="${comment != null}" class="comment">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong class="text-primary" th:text="${comment.userUsername != null ? comment.userUsername : 'Аноним'}"></strong>
                                            <small class="text-muted ms-2"
                                                   th:text="${comment.createdAt != null ? #temporals.format(comment.createdAt, 'dd.MM.yyyy HH:mm') : ''}"></small>
                                        </div>

                                        <!-- КНОПКИ УДАЛЕНИЯ КОММЕНТАРИЕВ -->
                                        <div class="comment-actions">
                                            <!-- Для автора комментария -->
                                            <div th:if="${comment.userUsername != null and #authentication.name == comment.userUsername}">
                                                <form th:action="@{/comments/{id}/delete(id=${comment.id})}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm action-btn"
                                                            onclick="return confirm('Удалить комментарий?')"
                                                            title="Удалить комментарий">
                                                        <i class="bi bi-trash"></i> Удалить
                                                    </button>
                                                </form>
                                            </div>

                                            <!-- Для админа -->
                                            <div th:if="${#authentication.name != comment.userUsername}" sec:authorize="hasRole('ROLE_ADMIN')">
                                                <form th:action="@{/comments/{id}/delete(id=${comment.id})}" method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-secondary btn-sm action-btn"
                                                            onclick="return confirm('Удалить комментарий?')"
                                                            title="Удалить комментарий (админ)">
                                                        <i class="bi bi-shield-x"></i> Удалить
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="mb-1" th:text="${comment.text != null ? comment.text : 'Текст отсутствует'}"></p>
                                </div>
                            </div>

                            <!-- Сообщение если комментариев нет -->
                            <div th:if="${review.comments == null or review.comments.empty}" class="text-muted">
                                <small><i class="bi bi-info-circle me-1"></i>Комментариев пока нет</small>
                            </div>

                            <!-- Форма добавления комментария -->
                            <div class="mt-3" sec:authorize="isAuthenticated()">
                                <form th:action="@{/comments/add}" method="post" class="d-flex gap-2">
                                    <input type="hidden" name="reviewId" th:value="${review.id}">
                                    <input type="text" name="text" class="form-control form-control-sm"
                                           placeholder="Написать комментарий..." required>
                                    <button type="submit" class="btn btn-primary btn-sm action-btn">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </form>
                            </div>

                            <!-- Подсказка для неавторизованных -->
                            <div class="mt-2" sec:authorize="not isAuthenticated()">
                                <small class="text-muted">
                                    <a th:href="@{/login}" class="text-decoration-none">Войдите</a>, чтобы оставить комментарий
                                </small>
                            </div>
                        </div>
                        <!-- КОНЕЦ БЛОКА КОММЕНТАРИЕВ -->

                    </div>
                </div>
            </div>

            <div th:if="${reviews == null or reviews.empty}" class="text-center py-5">
                <i class="bi bi-chat-dots display-1 text-muted"></i>
                <h5 class="text-muted mt-3">Пока нет рецензий</h5>
                <p class="text-muted">Будьте первым, кто поделится своим мнением!</p>
            </div>
        </div>
    </div>
</main>

<!-- Модальное окно редактирования -->
<div class="modal fade" id="editReviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Редактировать рецензию</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/reviews/update}" method="post">
                <div class="modal-body">
                    <input type="hidden" id="editReviewId" name="reviewId">
                    <div class="mb-3">
                        <label class="form-label">Текст рецензии</label>
                        <textarea class="form-control" id="editReviewText" name="text" rows="6" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Инициализация модального окна
    const editModal = document.getElementById('editReviewModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('editReviewId').value = button.getAttribute('data-review-id');
            document.getElementById('editReviewText').value = button.getAttribute('data-review-text');
        });
    }

    // Плавная прокрутка
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        });

        // === КОД ДЛЯ СОХРАНЕНИЯ ПОЗИЦИИ ПРОКРУТКИ ===

        // Сохраняем позицию прокрутки перед отправкой ЛЮБОЙ формы
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                // Сохраняем текущую позицию прокрутки
                sessionStorage.setItem('scrollPosition', window.pageYOffset || document.documentElement.scrollTop);

                // Находим ближайшую рецензию (если форма внутри рецензии)
                const reviewCard = this.closest('[id^="review-"]');
                if (reviewCard) {
                    sessionStorage.setItem('targetElementId', reviewCard.id);
                } else if ((window.pageYOffset || document.documentElement.scrollTop) > 500) {
                    // Сохраняем секцию рецензий если прокрутили достаточно далеко
                    sessionStorage.setItem('targetElementId', 'reviews-section');
                }
            });
        });

        // Восстанавливаем позицию прокрутки после загрузки страницы
        const savedPosition = sessionStorage.getItem('scrollPosition');
        const targetElementId = sessionStorage.getItem('targetElementId');

        if (savedPosition) {
            setTimeout(() => {
                if (targetElementId) {
                    // Пытаемся найти конкретный элемент
                    const targetElement = document.getElementById(targetElementId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    } else {
                        // Если элемент не найден, используем сохраненную позицию
                        window.scrollTo(0, parseInt(savedPosition));
                    }
                } else {
                    // Просто восстанавливаем позицию
                    window.scrollTo(0, parseInt(savedPosition));
                }

                // Очищаем storage
                sessionStorage.removeItem('scrollPosition');
                sessionStorage.removeItem('targetElementId');
            }, 100);
        }

        // Обработка якорей в URL (если нет сохраненной позиции)
        if (window.location.hash && !savedPosition) {
            setTimeout(() => {
                const targetElement = document.querySelector(window.location.hash);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }, 150);
        }
    });
</script>
</body>
</html>